## 개념 & 용어정리

## 목차
- [XSS(크로스 사이트 스크립팅, cross-site scripting)](#xss크로스-사이트-스크립팅-cross-site-scripting)
- [SQL Injection(SQL 삽입, SQL 주입)](#sql-injectionsql-삽입-sql-주입)
- [CSRF(사이트 간 요청 위조, cross-site request forgery, XSRF)](#csrf사이트-간-요청-위조-cross-site-request-forgery-xsrf)
- [안전하지 않은 리다이렉트와 포워드](#안전하지-않은-리다이렉트와-포워드)
- [널 포인터 역참조](#널-포인터-역참조)
- [정수 오버플로우(Integer Overflow)](#정수-오버플로우integer-overflow)
- [ESAPI](#esapi)
- [침입탐지(IDS)](#침입탐지ids)
- [액세스 제어](#액세스-제어)
- [운영체제 명령어 삽입](#운영체제-명령어-삽입)
- [세션 관리 취약점](#세션-관리-취약점)
- [파일 업로드 취약점](#파일-업로드-취약점)

---

### XSS(크로스 사이트 스크립팅, cross-site scripting)
웹사이트의 관리자가 아닌 이가 웹 페이지에 악성 스크립트를 삽입할 수 있는 취약점이다. 주로 게시판에 악성 스크립트가 담긴 글을 올리는 형태로 이루어진다.

#### 발생 원인
사용자로부터 입력 받은 값을 제대로 검사하지 않고 사용할 경우 발생한다. 사용자가 특정 웹사이트를 신용하는 부분을 노린 공격이라고 한다.

#### 피해
사용자의 정보(세션, 쿠키 등) 탈취, 비정상적인 기능 수행

#### 공격 유형
1. 비 지속적(Non-persistent) 기법

반사(Refected) XSS라고도 불리며, 가장 일반적인 유형이다. 웹 클라이언트가 제공하는 HTTP 쿼리 매개 변수에서 적절하지 않고, 구문 분석 및 해당 사용자에 대한 결과의 페이지를 표시하는 공격 기법이며, 검증되지 않은 사용자가 URL 파라미터나 HTTP 요청 헤더 정보를 수정하여 공격할 수 있다.

2. 지속적(Persistent) 기법

공격자가 제공한 데이터가 서버에 저장 된 다음 지속적으로 서비스를 제공하는 정상적인 페이지에서 다른 사용자에게 노출된다. 사용자들이 노출된 웹사이트를 사용하면, 사용자들의 정보가 공격자에게 전송이 되어도 당사자가 공격 행위를 깨닫지 못한다. 제 3자 웹사이트로 유인할 필요 없이 자동으로 렌더링되므로 비 지속적 기법에 비해 위험하다.

#### 방어법 (OWASP의 XSS 공격 방지 7계명)
```
0. 허용된 위치가 아닌 곳에 신뢰할 수 없는 데이터가 들어가는것을 허용하지 않는다.
1. 신뢰할 수 없는 데이터는 검증을 하여라.
2. HTML 속성에 신뢰할 수 없는 데이터가 들어갈 수 없도록 하여라.
3. 자바스크립트에 신뢰할 수 없는 값이 들어갈 수 없도록 하여라.
4. CSS의 모든 신뢰할 수 없는 값에 대해서 검증하여라.
5. URL 파라미터에 신뢰할 수 없는 값이 있는지 검증하여라.
6. HTML 코드를 전체적으로 한번 더 검증하여라.
```

<br>

### SQL Injection(SQL 삽입, SQL 주입)
코드 인젝션 공격 방법 중 하나로, 응용 프로그램 보안 상의 허점을 의도적으로 이용하여 악의적인 SQL문을 실행되게 함으로써 데이터베이스를 비정상적으로 조작하는 공격이다.

`statement = "SELECT * FROM users WHERE name = '" + userName + "';"`

위와 같은 코드에서 userName이 들어가는 자리에 악의적인 코드를 삽입하여

`SELECT * FROM users WHERE name = 'a';DROP TABLE users; SELECT * FROM userinfo WHERE 't' = 't';`

이런 식으로 공격할 수 있다.

#### Blind SQL Injection
평범한 SQL Injection과 같이 원하는 데이터를 가져올 쿼리를 삽입하는 기술로, 웹에서 SQL 삽입에 취약하나 데이터베이스 메시지가 공격자에게 보이지 않을 때 사용한다.

평범한 SQL Injection은 쿼리를 삽입하여 원하는 데이터를 한 번에 얻어낼 수 있는 반면, Blind SQL Injection은 쿼리가 참일 때와 거짓일 때의 서버의 반응 만으로 데이터를 얻어내는 기술이다. 보통 자동화된 툴을 사용하여 공격한다.

#### 방어법
1. 준비된 선언(Prepared statement)
사용자의 입력이 쿼리문으로부터 분리되기 때문에 효과적으로 방어할 수 있다.

1️⃣쿼리문이 DBMS로 전송되되, 사용자 입력값은 전송되지 않고 플레이스홀더로 표시된다. 2️⃣DBMS가 쿼리문을 분석하고 최적화를 진행한다. 3️⃣플레이스홀더에 입력할 사용자 입력 값이 전송되고 DBMS가 쿼리문을 실행한다.

2. 이스케이프
SQL에서 특별한 의미를 갖는 문자들을 이스케이프한다.

<br>

### CSRF(사이트 간 요청 위조, cross-site request forgery, XSRF)
사용자가 자신의 의지와는 무관하게 공격자가 의도한 행위를 특정 웹사이트에 요청하게 하는 공격이다.

#### 발생 원인
특정 웹사이트가 사용자의 웹 브라우저를 신용하는 상태를 노린 공격이다. 사용자가 웹사이트에 로그인 한 상태에서 사이트간 요청 위조 공격 코드가 삽입된 페이지를 열면, 공격 대상이 되는 웹사이트는 위조된 공격 명령이 믿을 수 있는 사용자로부터 발생된 것으로 판단하게 되어 공격에 노출된다.

공격자가 사용자의 쿠키나 자격 증명에 접근할 필요가 없다. 즉, 사용자의 브라우저가 이 정보를 저장하고 관련 서버에 대한 모든 요청에 자동으로 포함시킨다.

#### 방어법
1. Referrer 검증

서버 측에서 request referrer를 확인하여 domain이 일치하는지 검증하는 방법이다. 대부분의 CSRF 공격을 방어할 수 있으나, 같은 도메인 내의 페이지에 XSS 취약점이 있는 경우 취약해질 수 있다. domain 단위 검증에서 페이지 단위까지 검증하면 상기한 취약점에 대해서도 방어할 수 있다.

2. Security Token 적용(CSRF Token)

Referrer 검증이 불가한 환경이라면 Security Token을 활용할 수 있다. 사용자의 세션에 임의의 난수 값을 저장하고 사용자의 요청마다 해당 난수 값을 포함시켜 전송한다. 이후 서버 단에서 요청을 받을 때마다 세션에 저장된 토큰 값과 요청 파라미터에 전달되는 토큰 값이 일치하는지 검증한다. 이 방법 역시 같은 도메인 내에 XSS 취약점이 있다면 취약해진다.

<br>


### 안전하지 않은 리다이렉트와 포워드
![리다이렉트와 포워드의 특징](https://i2sec.github.io/images/2017-03-30/2.png)

#### 검증되지 않은 리다이렉트
`response.sendRedirect("http://www.mysite.com");`

`response.sendRedirect(request.getParameter("url"));`

순서대로 안전한 URL 리다이렉트 예시 코드와, 취약한 URL 리다이렉트 예시 코드이다.

사용자가 넘겨준 매개변수로 각 언어별로 리다이렉트 처리 시 취약점이 발생하여 악의적 URL로 렌더링 될 수 있다는 취약점이다.

#### 검증되지 않은 포워드
```java
public class ForwardServlet extends HttpServlet {
  protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
    String query = request.getQueryString();
    if(query.contains("fwd")) {
      String fwd = request.getParameter("fwd");
      try {
        request.getRequestDispatcher(fwd).forward(request, response);
      } catch(ServletException e) {
        e.printStackTrace();
      }
    }
  }
}
```

`http://www.example.com/function.jsp?fwd=admin.jsp`

리다이렉트와 마찬가지로 사용자에게 전달받은 값으로 포워딩을 해서 발생하는 취약점이다. 접근제어를 우회하는 방식으로 공격된다.

Spring Security의 보안 필터가 include나 forward 시 보안 제약 조건이 성립이 되지 않아 동작하지 않으므로 접근제어가 우회가 되면서 발생한다.

<br>

### 널 포인터 역참조
null값을 가지는 참조 변수를 사용해 객체의 속성이나 메소드를 사용하는 경우 NullPointerException이 발생한다. 파라미터 값이 null인지 체크해주는 로직이 존재하지 않는다면 예외가 발생한다.

취약점을 제거하기 위해 null이 될 수 있는 레퍼런스는 참조하기 전에 null인지 검사한다.

<br>

### 정수 오버플로우(Integer Overflow)
정수값이 허용된 가장 큰 값보다 더 커져서 실제 저장되는 값은 의도하지 않게 아주 작은 수이거나 음수가 되어 프로그램이 예기치 않게 동작될 수 있는 취약점이다.

대부분의 컴파일러에서 오버플로우를 무시하기 때문에 잘못된 값이 저장될 수 있으며, 이로 인해 다른 종류의 버그를 초래할 수 있다. 또한 발견하기 어렵기 때문에 에러 검사 코드에 검출되지 않는 경우도 있다.

취약점을 제거하기 위해 범위를 체크하는 모듈을 사용하여 지정된 범위 밖의 입력이 들어오지 못하도록 한다.

<br>

### ESAPI
- <https://openeg.co.kr/495>
- <https://www.owasp.org/index.php/Category:OWASP_Enterprise_Security_API>

Enterprise Security API의 약자로, 웹 애플리케이션 개발 과정에서 발생하는 다양한 보안 침해사고를 해결하기 위해 OWASP에서 OWASP TOP10과 함께 해당 문제점을 개선하기 위해 제작, 배포되는 보안 라이브러리이다.

The ESAPI library는 여러 플랫폼 버전에서 적용할 수 있도록 지원되고 있으며, Java, PHP, .NET, Python 언어를 지원한다.

#### ESAPI Top 10
![ESAPI Architecture](https://static.javadoc.io/org.owasp.esapi/esapi/2.0.1/org/owasp/esapi/doc-files/Architecture.jpg)

![ESAPI Top Ten Coverage](https://static.javadoc.io/org.owasp.esapi/esapi/2.0.1/org/owasp/esapi/doc-files/OWASPTopTen.jpg)

```
1. 사이드 간 스크립팅(XSS)
2. 주입 결점 (Injection 공격 관련된 것)
3. 악의적인 파일 실행
4. 불안정한 객체 직접 참조
5. 사이트 간 요청 위조(CSRF)
6. 유출 및 부적절한 오류 처리
7. 손상된 인증 및 세션
8. 불안정한 암호화 저장소
9. 불안정한 통신
10. URL 접근 제한 실패
```

<br>

### 침입탐지(IDS)
침입 탐지 시스템(Intrusion Detection System, IDS)은 일반적으로 시스템에 대한 원치 않는 조작을 탐지해준다. 방화벽이 탐지할 수 없는 모든 종류의 악의적인 네트워크 트래픽 및 컴퓨터 사용을 탐지하기 위해 필요하다.

#### IDS의 구성 요소
- 센서
   - 보안 이벤트를 발생시킴
- 콘솔
   - 이벤트를 모니터링하고 센서를 제어하거나 경계(alert)시킴
- 엔진
   - 센서에 의해 기록된 이벤트를 데이터베이스에 기록
   - 시스템 규칙을 사용하여 수신된 보안 이벤트로부터 경고 생성

#### 분류 방법
- 센서의 종류와 위치
- 엔진이 경고를 만드는 데 사용하는 방법론

#### 악용 탐지 vs 비정상 탐지
- 악용 탐지(misuse detection system)
   - 악의적인 것으로 추정되는 트래픽 또는 애플리케이션 데이터의 패턴을 감시하여 침입 식별
   - 알려진 공격만 탐지할 수 있다고 여겨짐
   - 정보를 수집하고 분석하여 공격 시그니처를 저장하는 데이터베이스를 통해 비교함
- 비정상 탐지
   - 변칙 기반 침입 탐지 시스템(anomaly-based intrusion detection system)
   - 네트워크 또는 호스트의 일반적인 동작과 다른 것으로 추정되는 트래픽 또는 애플리케이션 컨텐츠를 시스템 운영자에게 알림
   - 일반적으로 스스로 학습함

#### 네트워크 기반 시스템 vs 호스트 기반 시스템
- 네트워크 기반 시스템
   - 센서 - DMZ나 네트워크 경계의 초크 지점(choke point)에 위치
   - 악의적 트래픽 탐지를 위해 모든 네트워크 트래픽의 흐름을 캡처하여 각각의 패킷 내용을 분석함
   - 네트워크 트래픽을 검사하고 여러 호스트들을 모니터하여 침입을 식별하는 독립된 플랫폼
   - 허브, 네트워크, 스위치에 연결하여 네트워크 트래픽에 접근
- 호스트 기반 시스템
   - 센서 - 설치된 호스트의 모든 활동을 감시하는 소프트웨어 에이전트로 구성됨
   - 호스트에서 시스템 콜, 애플리케이션 로그, 파일 시스템의 수정 사항(이진 파일, 패스워드 파일, capability/acl 데이터베이스), 호스트의 동작과 상태 등을 분석하여 침입을 식별하는 에이전트로 구성됨

#### 수동적 시스템 vs 반응적 시스템
- 수동적 시스템
   - 센서 - 가능성 있는 보안 침해 사항 탐지하여, 정보를 로그로 기록하고 콘솔을 통해 경고 신호를 보냄
- 반응적 시스템
   - 센서 - 의심스러운 동작에 대해 자율적으로 또는 시스템 운영자에 의해 사용자를 로그오프 시키거나, 방화벽을 다시 프로그래밍하여 의심스러운 악의적 출처로부터 네트워크 트래픽을 차단하도록 응수함

<br>

### 액세스 제어
특정 사용자가 제한된 자원에 액세스할 수 있도록 허용하기 위해 실행하는 기술이다. 액세스 제어를 사용하면 다음을 결정할 수 있다.

- 관리자 서버에 액세스할 수 있는 사용자
- 액세스할 수 있는 응용 프로그램
- 웹 사이트의 파일 또는 디렉터리에 액세스할 수 있는 사용자

ACE(Access Control Entries)라는 규칙 계층을 만들어 액세스를 허용 또는 거부한다. ACE의 모음을 액세스 제어 목록(ACL)이라고 한다.

기본적으로 서버에는 하나의 ACL 파일이 있다. 웹서버는 들어오는 요청에 ACL이 구성되어 있는지 확인하고, 현재 요청에 적용되는 ACL이 있을 경우 서버는 ACE를 평가하여 접근 허용 여부를 결정한다. 기준 항목은 다음과 같다.

- 요청하는 사용자(사용자 그룹)
- 요청의 출처(호스트-IP)
- 요청이 발생한 시간(예: 하루 중 시간)
- 사용되는 연결의 종류(SSL)

아래 그림은 `Sun Java System Web Server 7.0`에서 액세스 제어가 작동하는 방식을 나타낸다.

![액세스 제어 작동 예시](https://docs.oracle.com/cd/E19146-01/820-0874/images/training8.gif)

<br>

### 운영체제 명령어 삽입
웹 어플리케이션에서 `system()`, `exec()`과 같은 시스템 명령어를 실행시킬 수 있는 함수를 제공하며 사용자 입력 값에 대한 필터링이 제대로 이루어지지 않을 경우 공격자가 운영체제 시스템 명령어를 호출하여 백도어 설치나 관리자 권한 탈취 등의 영향을 야기할 수 있는 취약점이다.

공격자는 주로 URL의 파라미터를 통해 해당 공격을 실행한다.

대응 방안으로는 1️⃣웹 방화벽에서 모든 사용자 입력 폼을 대상으로 특수문자, 특수구문 필터링 규칙을 적용하는 방법과, 2️⃣웹 애플리케이션에서 시큐어 코딩을 적용하는 방법이 있다.

웹 애플리케이션 운영 시 가급적 소스코드 상에 운영체제 명령어를 사용하지 않는 것이 좋으나, 부득이하게 운영체제 명령어를 사용해야 한다면 다음과 같은 방법을 사용한다. 1️⃣패턴 기법을 통하여 허용 가능한 명령어가 맞는지 확인하거나, 2️⃣switch문을 이용하여 허용된 명령어만 실행이 가능하도록 코드를 짠다.

<br>

### 세션 관리 취약점
세션을 이용하여 공격자가 다른 사용자의 ID로 가장(masquerade) 할 수 있는 취약점이다.

취약점은 다음과 같은 경우에 드러난다. 해결 방법을 덧붙이겠다.

1. URL에 세션 정보가 노출되는 경우
   - URL에 세션 ID와 같은 정보를 표시하지 않는다.
2. 세션 타임아웃이 없는 사이트에서 로그아웃 없이 브라우저만 닫았을 때 세션이 유지되는 경우
   - 세션 타임아웃을 잡아둔다.
   - 중복 로그인을 허용하지 않는다.
3. 쿠키 변조
   - 쿠키는 정보를 클라이언트 상에 저장하기 때문에 사용자 인증 등의 기능은 쿠키 대신 세션 방식을 사용한다.
   - 쿠키 방식을 활용해야 한다면 안전한 암호화 알고리즘(SEED, 3DES, AES 등)을 사용한다.

<br>

### 파일 업로드 취약점
파일 업로드 기능이 존재하는 웹 애플리케이션에서 확장자 필터링이 제대로 이루어지지 않았을 경우 공격자가 악성 스크립트 파일(Web Shell)을 업로드하여 실행시킨 후, 웹 서버를 장악하고 피해를 주는 행위이다.

#### 공격 방법
1. 취약점 점검
   - 지정된 확장자 외의 파일을 업로드 할 수 있는지 확인한 후, 업로드 할 수 있다면 접근 및 실행이 가능한지 확인한다. 접근이 가능할 경우 피싱 페이지로 활용될 수 있고, 실행이 가능하다면 시스템의 제어 권한을 획득할 수 있다.
2. 프록시 툴을 이용한 확장자 검사우회 파일 업로드
   - 파일의 Content-Type을 프록시 툴로 변조하여 우회한다.
3. 널바이트 이용
   - C/C++에서 널바이트는 문자열의 끝을 의미하므로 확장자를 숨기기 위한 목적으로 이용될 수 있다. C루틴을 처리하거나 내부의 C API를 호출하는 함수를 사용하는 경우 발생할 수 있다.
4. SQL Injection 이용
   - MySQL - `info outfile()` 함수를 이용하여 웹 서버에 파일을 생성한다.
   - MSSQL의 저장 프로시저를 이용하여 윈도우 명령어인 `echo`를 통하여 특정 명령어를 작성하고, 파이프(`>>`)를 통하여 특정 파일에 삽입한다.
5. Exploit을 통한 root 권한 획득
   - exploit이란 소프트웨어의 버그 등의 설계상 결함을 이용한 공격 코드를 뜻한다.

#### 방어법
- 지정된 확장자를 제외한 다른 확장자의 업로드를 제한하거나, 스크립트 파일의 업로드 및 실행을 금지시킨다.
- 파일명이나 확장자 검증을 우회하는 것을 방지하기 위해 대소문자를 구분하지 않고 문자열을 비교하고, 특수문자가 있을 경우 업로드를 금지시킨다.
- 웹 서버 엔진 설정 시 업로드 된 디렉터리의 server side script 언어의 실행 권한을 제거하고, 업로드 된 파일명과 확장자를 난수화 하여 변경한다.
- 업로드 된 파일을 루트 디렉터리와 동일한 수준에 존재하는 다른 디렉터리에 저장하거나 URL 요청에 의해서 직접 접근할 수 없는 곳에 저장시키고, 상위 폴더로 이동하는 것을 제한시킨다.

<br>

---

## 참고 사이트
- <https://ko.wikipedia.org/wiki/%EC%9C%84%ED%82%A4%EB%B0%B1%EA%B3%BC:%EB%8C%80%EB%AC%B8>
- <https://developer.mozilla.org/ko/docs/Learn/Server-side/First_steps/Website_security>
- <https://itstory.tk/entry/CSRF-%EA%B3%B5%EA%B2%A9%EC%9D%B4%EB%9E%80-%EA%B7%B8%EB%A6%AC%EA%B3%A0-CSRF-%EB%B0%A9%EC%96%B4-%EB%B0%A9%EB%B2%95>
- <https://cocomo.tistory.com/305>
- <https://i2sec.github.io/2017/03/30/owasp_top_10_forward.html>
- <https://www.owasp.org/index.php/Category:OWASP_Enterprise_Security_API>
- <https://openeg.co.kr>
- <https://static.javadoc.io/org.owasp.esapi/esapi/2.0.1/org/owasp/esapi/package-summary.html>
- <https://docs.oracle.com/cd/E19146-01/820-0874/gczxs/index.html>
- KISA - 홈페이지 취약점 진단·제거 가이드.pdf
- <https://intadd.tistory.com/100>
- <https://skynarciss.tistory.com/59>
- <https://4rgos.tistory.com/4>
